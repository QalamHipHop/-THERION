"""
√ÜTHERION - Advanced AI-Powered Banking System
Main Application Entry Point
"""
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager
import logging
from datetime import datetime

# Import configurations
try:
    from app.core.config import settings
        from app.core.database import init_db, close_db, check_database_health
            from app.core.redis_client import redis_client
            except ImportError:
                # ÿß⁄Øÿ± ŸÅÿß€åŸÑ‚ÄåŸáÿß ŸÜ€åÿ≥ÿ™ŸÜÿØÿå ÿßÿ≤ ÿ™ŸÜÿ∏€åŸÖÿßÿ™ Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ
                    class Settings:
                            APP_NAME = "√ÜTHERION"
                                    APP_VERSION = "1.0.0"
                                            DEBUG = True
                                                    BACKEND_CORS_ORIGINS = ["*"]
                                                        settings = Settings()

                                                        # Setup Logging
                                                        logging.basicConfig(
                                                            level=logging.INFO,
                                                                format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
                                                                )
                                                                logger = logging.getLogger(__name__)

                                                                # ================== Lifespan Events ==================
                                                                @asynccontextmanager
                                                                async def lifespan(app: FastAPI):
                                                                    """ŸÖÿØ€åÿ±€åÿ™ startup Ÿà shutdown"""
                                                                        # Startup
                                                                            logger.info("üöÄ Starting √ÜTHERION...")
                                                                                
                                                                                    try:
                                                                                            # ÿßÿ™ÿµÿßŸÑ ÿ®Ÿá Redis
                                                                                                    if 'redis_client' in globals():
                                                                                                                await redis_client.connect()
                                                                                                                            logger.info("‚úÖ Redis connected")
                                                                                                                                except Exception as e:
                                                                                                                                        logger.warning(f"‚ö†Ô∏è Redis connection failed: {e}")
                                                                                                                                            
                                                                                                                                                try:
                                                                                                                                                        # ÿßÿ™ÿµÿßŸÑ ÿ®Ÿá Database
                                                                                                                                                                if 'init_db' in globals():
                                                                                                                                                                            await init_db()
                                                                                                                                                                                        logger.info("‚úÖ Database initialized")
                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                    logger.warning(f"‚ö†Ô∏è Database initialization failed: {e}")
                                                                                                                                                                                                        
                                                                                                                                                                                                            logger.info("‚úÖ √ÜTHERION started successfully!")
                                                                                                                                                                                                                
                                                                                                                                                                                                                    yield
                                                                                                                                                                                                                        
                                                                                                                                                                                                                            # Shutdown
                                                                                                                                                                                                                                logger.info("üõë Shutting down √ÜTHERION...")
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                if 'redis_client' in globals():
                                                                                                                                                                                                                                                            await redis_client.close()
                                                                                                                                                                                                                                                                except:
                                                                                                                                                                                                                                                                        pass
                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                        if 'close_db' in globals():
                                                                                                                                                                                                                                                                                                    await close_db()
                                                                                                                                                                                                                                                                                                        except:
                                                                                                                                                                                                                                                                                                                pass
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                        logger.info("‚úÖ √ÜTHERION shutdown complete")

                                                                                                                                                                                                                                                                                                                        # ================== Create App ==================
                                                                                                                                                                                                                                                                                                                        app = FastAPI(
                                                                                                                                                                                                                                                                                                                            title=settings.APP_NAME,
                                                                                                                                                                                                                                                                                                                                version=settings.APP_VERSION,
                                                                                                                                                                                                                                                                                                                                    description="""
                                                                                                                                                                                                                                                                                                                                        üåü **ÿ≥€åÿ≥ÿ™ŸÖ ÿ®ÿßŸÜ⁄©ÿØÿßÿ±€å ŸÜŸà€åŸÜ ÿ®ÿß ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å**
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                Ÿà€å⁄ò⁄Ø€å‚ÄåŸáÿß:
                                                                                                                                                                                                                                                                                                                                                    - ⁄©€åŸÅ ŸæŸàŸÑ ⁄ÜŸÜÿØÿßÿ±ÿ≤€å (ÿ±€åÿßŸÑÿå ÿØŸÑÿßÿ±ÿå ÿßÿ±ÿ≤Ÿáÿß€å ÿØ€åÿ¨€åÿ™ÿßŸÑ)
                                                                                                                                                                                                                                                                                                                                                        - ÿØÿ±⁄ØÿßŸá‚ÄåŸáÿß€å Ÿæÿ±ÿØÿßÿÆÿ™ ÿß€åÿ±ÿßŸÜ€å (ÿ≤ÿ±€åŸÜ‚ÄåŸæÿßŸÑÿå ÿ¢€åÿØ€å‚ÄåŸæ€å Ÿà...)
                                                                                                                                                                                                                                                                                                                                                            - ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å ŸÖÿßŸÑ€å
                                                                                                                                                                                                                                                                                                                                                                - ÿßŸÖŸÜ€åÿ™ Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá
                                                                                                                                                                                                                                                                                                                                                                    """,
                                                                                                                                                                                                                                                                                                                                                                        docs_url="/docs",
                                                                                                                                                                                                                                                                                                                                                                            redoc_url="/redoc",
                                                                                                                                                                                                                                                                                                                                                                                lifespan=lifespan,
                                                                                                                                                                                                                                                                                                                                                                                    debug=settings.DEBUG
                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                    # ================== CORS Middleware ==================
                                                                                                                                                                                                                                                                                                                                                                                    app.add_middleware(
                                                                                                                                                                                                                                                                                                                                                                                        CORSMiddleware,
                                                                                                                                                                                                                                                                                                                                                                                            allow_origins=settings.BACKEND_CORS_ORIGINS,
                                                                                                                                                                                                                                                                                                                                                                                                allow_credentials=True,
                                                                                                                                                                                                                                                                                                                                                                                                    allow_methods=["*"],
                                                                                                                                                                                                                                                                                                                                                                                                        allow_headers=["*"],
                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                        # ================== Security Headers Middleware ==================
                                                                                                                                                                                                                                                                                                                                                                                                        @app.middleware("http")
                                                                                                                                                                                                                                                                                                                                                                                                        async def add_security_headers(request: Request, call_next):
                                                                                                                                                                                                                                                                                                                                                                                                            response = await call_next(request)
                                                                                                                                                                                                                                                                                                                                                                                                                response.headers["X-Frame-Options"] = "DENY"
                                                                                                                                                                                                                                                                                                                                                                                                                    response.headers["X-Content-Type-Options"] = "nosniff"
                                                                                                                                                                                                                                                                                                                                                                                                                        response.headers["X-XSS-Protection"] = "1; mode=block"
                                                                                                                                                                                                                                                                                                                                                                                                                            return response

                                                                                                                                                                                                                                                                                                                                                                                                                            # ================== Request Logging Middleware ==================
                                                                                                                                                                                                                                                                                                                                                                                                                            @app.middleware("http")
                                                                                                                                                                                                                                                                                                                                                                                                                            async def log_requests(request: Request, call_next):
                                                                                                                                                                                                                                                                                                                                                                                                                                start_time = datetime.now()
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                        # Log request
                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"üì• {request.method} {request.url.path}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Process request
                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = await call_next(request)
                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Log response
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    process_time = (datetime.now() - start_time).total_seconds()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"üì§ {request.method} {request.url.path} - {response.status_code} ({process_time:.3f}s)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return response

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ================== Root Endpoints ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                @app.get("/", tags=["Root"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                async def root():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """ÿµŸÅÿ≠Ÿá ÿßÿµŸÑ€å API"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "app": settings.APP_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "version": settings.APP_VERSION,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "status": "running",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "message": "üåü ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ ÿ®Ÿá √ÜTHERION - ÿ≥€åÿ≥ÿ™ŸÖ ÿ®ÿßŸÜ⁄©ÿØÿßÿ±€å ŸÜŸà€åŸÜ ÿ®ÿß ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "message_en": "Welcome to √ÜTHERION - Advanced AI-Powered Banking System",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "docs": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "swagger": "/docs",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "redoc": "/redoc"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "endpoints": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "health": "/health",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "info": "/info"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "developer": "QalamHipHop",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "repository": "https://github.com/QalamHipHop/-THERION"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.get("/health", tags=["Health"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def health_check():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """ÿ®ÿ±ÿ±ÿ≥€å ÿ≥ŸÑÿßŸÖÿ™ ÿ≥€åÿ≥ÿ™ŸÖ"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            health_status = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "status": "healthy",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "timestamp": datetime.now().isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "services": {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ÿ®ÿ±ÿ±ÿ≥€å Database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if 'check_database_health' in globals():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db_healthy = await check_database_health()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    health_status["services"]["database"] = "healthy" if db_healthy else "unhealthy"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        health_status["services"]["database"] = "not_configured"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    health_status["services"]["database"] = f"error: {str(e)}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ÿ®ÿ±ÿ±ÿ≥€å Redis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'redis_client' in globals():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    redis_healthy = await redis_client.redis.ping() if redis_client.redis else False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                health_status["services"]["redis"] = "healthy" if redis_healthy else "unhealthy"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    health_status["services"]["redis"] = "not_configured"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                health_status["services"]["redis"] = f"error: {str(e)}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return health_status

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.get("/info", tags=["Info"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def system_info():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ≥€åÿ≥ÿ™ŸÖ"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "app_name": settings.APP_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "version": settings.APP_VERSION,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "environment": getattr(settings, 'ENVIRONMENT', 'development'),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "debug_mode": settings.DEBUG,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "features": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "ai_insights": getattr(settings, 'FEATURE_AI_INSIGHTS', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "auto_invest": getattr(settings, 'FEATURE_AUTO_INVEST', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "p2p_transfer": getattr(settings, 'FEATURE_P2P_TRANSFER', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "staking": getattr(settings, 'FEATURE_STAKING', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "supported_currencies": getattr(settings, 'SUPPORTED_CURRENCIES', ["IRR", "USD", "USDT", "BTC"]),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "payment_gateways": ["ZarinPal", "IDPay", "NextPay", "PayPing", "Zibal"],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "documentation": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "swagger_ui": "/docs",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "redoc": "/redoc"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ================== Demo Endpoints ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @app.get("/api/demo/currencies", tags=["Demo"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async def get_currencies():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """ŸÑ€åÿ≥ÿ™ ÿßÿ±ÿ≤Ÿáÿß€å Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ÿ¥ÿØŸá (ÿØŸÖŸà)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "fiat": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {"code": "IRR", "name": "ÿ±€åÿßŸÑ ÿß€åÿ±ÿßŸÜ", "symbol": "Ô∑º"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {"code": "USD", "name": "ÿØŸÑÿßÿ± ÿ¢ŸÖÿ±€å⁄©ÿß", "symbol": "$"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {"code": "EUR", "name": "€åŸàÿ±Ÿà", "symbol": "‚Ç¨"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "crypto": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {"code": "BTC", "name": "ÿ®€åÿ™‚Äå⁄©Ÿà€åŸÜ", "symbol": "‚Çø"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {"code": "ETH", "name": "ÿßÿ™ÿ±€åŸàŸÖ", "symbol": "Œû"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {"code": "USDT", "name": "ÿ™ÿ™ÿ±", "symbol": "‚ÇÆ"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "native": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "code": "√ÜTHER",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "name": "ÿ™Ÿà⁄©ŸÜ ÿßÿ™ÿ±€åŸàŸÜ",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "symbol": "‚ö°"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.get("/api/demo/rates", tags=["Demo"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def get_exchange_rates():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """ŸÜÿ±ÿÆ ÿßÿ±ÿ≤Ÿáÿß (ÿØŸÖŸà - ŸÇ€åŸÖÿ™‚ÄåŸáÿß€å ŸÅÿ±ÿ∂€å)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "timestamp": datetime.now().isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "base": "IRR",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "rates": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "USD": 0.000020,  # 1 ÿØŸÑÿßÿ± = 50,000 ÿ™ŸàŸÖÿßŸÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "EUR": 0.000018,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "BTC": 0.00000000004,  # 1 BTC = 2.5 ŸÖ€åŸÑ€åÿßÿ±ÿØ ÿ™ŸàŸÖÿßŸÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "ETH": 0.0000000067,   # 1 ETH = 150 ŸÖ€åŸÑ€åŸàŸÜ ÿ™ŸàŸÖÿßŸÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "USDT": 0.000018,      # 1 USDT = 55,000 ÿ™ŸàŸÖÿßŸÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "√ÜTHER": 0.001         # 1 √ÜTHER = 1,000 ÿ™ŸàŸÖÿßŸÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "note": "ÿß€åŸÜ ŸÜÿ±ÿÆ‚ÄåŸáÿß ŸÅÿ±ÿ∂€å Ÿáÿ≥ÿ™ŸÜÿØ. ÿØÿ± ŸÜÿ≥ÿÆŸá ŸàÿßŸÇÿπ€å ÿßÿ≤ API Ÿáÿß€å ŸÇ€åŸÖÿ™ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                @app.post("/api/demo/calculate", tags=["Demo"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                async def calculate_exchange(from_currency: str, to_currency: str, amount: float):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ÿ™ÿ®ÿØ€åŸÑ ÿßÿ±ÿ≤ (ÿØŸÖŸà)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ŸÜÿ±ÿÆ‚ÄåŸáÿß€å ŸÅÿ±ÿ∂€å
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            rates = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "IRR": 1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "USD": 50000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "EUR": 55000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "BTC": 2500000000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "ETH": 150000000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "USDT": 55000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "√ÜTHER": 1000
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if from_currency not in rates or to_currency not in rates:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return JSONResponse(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status_code=400,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                content={"error": "ÿßÿ±ÿ≤ ŸÜÿßŸÖÿπÿ™ÿ®ÿ±"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ŸÖÿ≠ÿßÿ≥ÿ®Ÿá
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    from_to_irr = amount * rates[from_currency]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        result = from_to_irr / rates[to_currency]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fee = result * 0.001  # ⁄©ÿßÿ±ŸÖÿ≤ÿØ 0.1Ÿ™
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                final = result - fee
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "from": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "currency": from_currency,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "amount": amount
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "to": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "currency": to_currency,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "amount": round(final, 8)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "rate": round(rates[to_currency] / rates[from_currency], 8),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "fee": round(fee, 8),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "timestamp": datetime.now().isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ================== Error Handlers ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.exception_handler(404)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def not_found_handler(request: Request, exc):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return JSONResponse(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status_code=404,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        content={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "error": "€åÿßŸÅÿ™ ŸÜÿ¥ÿØ",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "message": f"ŸÖÿ≥€åÿ± {request.url.path} Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "suggestion": "ÿ®Ÿá /docs ÿ®ÿ±Ÿà€åÿØ ÿ™ÿß ŸÑ€åÿ≥ÿ™ APIŸáÿß ÿ±ÿß ÿ®ÿ®€åŸÜ€åÿØ"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.exception_handler(500)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def internal_error_handler(request: Request, exc):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.error(f"Internal error: {exc}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return JSONResponse(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_code=500,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                content={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "error": "ÿÆÿ∑ÿß€å ÿ≥ÿ±Ÿàÿ±",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "message": "ŸÖÿ¥⁄©ŸÑ€å ÿØÿ± ÿ≥ÿ±Ÿàÿ± ÿ±ÿÆ ÿØÿßÿØŸá ÿßÿ≥ÿ™"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ================== Run Server ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import uvicorn
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uvicorn.run(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "app.main:app",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            host="0.0.0.0",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    port=8000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            reload=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    log_level="info"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )