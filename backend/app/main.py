"""
Ã†THERION - Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛŒÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
ÛŒÚ© ÙØ§ÛŒÙ„ - Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¯Ø§Ø®Ù„Ø´!
Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: QalamHipHop
"""

# Ù†ØµØ¨ Ø®ÙˆØ¯Ú©Ø§Ø± packages
import subprocess
import sys

def install_packages():
    """Ù†ØµØ¨ Ø®ÙˆØ¯Ú©Ø§Ø± packages Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²"""
    packages = ['fastapi', 'uvicorn']
    for package in packages:
        try:
            __import__(package)
        except ImportError:
            print(f"ğŸ“¦ Ø¯Ø± Ø­Ø§Ù„ Ù†ØµØ¨ {package}...")
            subprocess.check_call([sys.executable, "-m", "pip", "install", package, "-q"])
            print(f"âœ… {package} Ù†ØµØ¨ Ø´Ø¯")

# Ù†ØµØ¨ packages
install_packages()

# Ø­Ø§Ù„Ø§ import Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, JSONResponse
from datetime import datetime
from typing import Dict, List, Optional
import uvicorn

# ==================== Ø³Ø§Ø®Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ ====================
app = FastAPI(
    title="Ã†THERION - Ø§ØªØ±ÛŒÙˆÙ†",
    description="ğŸŒŸ Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛŒÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ==================== Ø¯ÛŒØªØ§ ====================
# Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ (Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†)
PRICES = {
    "USDT": 55000,
    "BTC": 2500000000,
    "ETH": 150000000,
    "USD": 50000,
    "EUR": 55000,
    "Ã†THER": 1000  # ØªÙˆÚ©Ù† Ø¨ÙˆÙ…ÛŒ
}

# Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ù…Ùˆ
demo_users = {}
demo_wallets = {}

# ==================== ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ====================
@app.get("/", response_class=HTMLResponse)
async def home():
    """ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø²ÛŒØ¨Ø§"""
    return """
    <!DOCTYPE html>
    <html dir="rtl" lang="fa">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ã†THERION - Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            .container {
                max-width: 900px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
            h1 {
                color: #667eea;
                font-size: 3em;
                text-align: center;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            }
            .emoji { font-size: 1.5em; }
            .subtitle {
                text-align: center;
                color: #718096;
                font-size: 1.2em;
                margin-bottom: 30px;
            }
            .status-box {
                background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                text-align: center;
                font-size: 1.3em;
                margin: 20px 0;
                box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
            }
            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 30px 0;
            }
            .card {
                background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                border: 2px solid #e2e8f0;
                transition: all 0.3s;
            }
            .card:hover {
                transform: translateY(-5px);
                border-color: #667eea;
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            }
            .card-icon { font-size: 2.5em; margin-bottom: 10px; }
            .card-title { font-weight: bold; color: #2d3748; margin-bottom: 5px; }
            .card-value { color: #667eea; font-size: 1.1em; }
            .button {
                display: block;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 30px;
                border-radius: 10px;
                text-decoration: none;
                text-align: center;
                font-weight: bold;
                margin: 10px 0;
                transition: all 0.3s;
                border: none;
                cursor: pointer;
            }
            .button:hover {
                transform: scale(1.02);
                box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            }
            .info-box {
                background: #edf2f7;
                padding: 20px;
                border-radius: 10px;
                margin: 20px 0;
                border-right: 4px solid #667eea;
            }
            .info-row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #cbd5e0;
            }
            .info-row:last-child { border: none; }
            @media (max-width: 600px) {
                h1 { font-size: 2em; }
                .container { padding: 20px; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1><span class="emoji">ğŸŒŸ</span> Ã†THERION</h1>
            <p class="subtitle">Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛŒÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</p>
            
            <div class="status-box">
                âœ… Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª!
            </div>
            
            <div class="grid">
                <div class="card">
                    <div class="card-icon">ğŸ’°</div>
                    <div class="card-title">Ú©ÛŒÙ Ù¾ÙˆÙ„</div>
                    <div class="card-value">Ú†Ù†Ø¯Ø§Ø±Ø²ÛŒ</div>
                </div>
                <div class="card">
                    <div class="card-icon">ğŸ”„</div>
                    <div class="card-title">ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø²</div>
                    <div class="card-value">Ø¢Ù†ÛŒ</div>
                </div>
                <div class="card">
                    <div class="card-icon">ğŸ¤–</div>
                    <div class="card-title">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</div>
                    <div class="card-value">Ù…Ø´Ø§ÙˆØ± Ù…Ø§Ù„ÛŒ</div>
                </div>
                <div class="card">
                    <div class="card-icon">ğŸ”’</div>
                    <div class="card-title">Ø§Ù…Ù†ÛŒØª</div>
                    <div class="card-value">Ù¾ÛŒØ´Ø±ÙØªÙ‡</div>
                </div>
            </div>
            
            <div class="info-box">
                <h3 style="color: #2d3748; margin-bottom: 15px;">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…</h3>
                <div class="info-row">
                    <span>Ù†Ø³Ø®Ù‡:</span>
                    <span style="color: #667eea;">1.0.0</span>
                </div>
                <div class="info-row">
                    <span>ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡:</span>
                    <span style="color: #667eea;">QalamHipHop</span>
                </div>
                <div class="info-row">
                    <span>ÙˆØ¶Ø¹ÛŒØª:</span>
                    <span style="color: #48bb78;">âœ… Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                </div>
            </div>
            
            <a href="/docs" class="button">ğŸ“š Ù…Ø³ØªÙ†Ø¯Ø§Øª API (Swagger)</a>
            <a href="/api/prices" class="button">ğŸ’¹ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</a>
            <a href="/health" class="button">ğŸ¥ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</a>
        </div>
    </body>
    </html>
    """

# ==================== API Endpoints ====================

@app.get("/health")
async def health_check():
    """Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…"""
    return {
        "status": "healthy",
        "message": "âœ… Ã†THERION Ø¨Ù‡ Ø®ÙˆØ¨ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯",
        "timestamp": datetime.now().isoformat(),
        "version": "1.0.0",
        "uptime": "running"
    }

@app.get("/api/prices")
async def get_prices():
    """Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²Ù‡Ø§"""
    return {
        "timestamp": datetime.now().isoformat(),
        "base": "IRR",
        "note": "Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†",
        "prices": {
            currency: {
                "buy": price,
                "sell": int(price * 0.98),
                "currency": currency
            }
            for currency, price in PRICES.items()
        }
    }

@app.post("/api/convert")
async def convert_currency(
    from_currency: str,
    to_currency: str, 
    amount: float
):
    """ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø²"""
    
    currencies = {"IRR": 1, **PRICES}
    
    if from_currency not in currencies or to_currency not in currencies:
        raise HTTPException(
            status_code=400,
            detail=f"Ø§Ø±Ø² Ù†Ø§Ù…Ø¹ØªØ¨Ø±! Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±: {', '.join(currencies.keys())}"
        )
    
    if amount <= 0:
        raise HTTPException(status_code=400, detail="Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² ØµÙØ± Ø¨Ø§Ø´Ø¯")
    
    # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±ÛŒØ§Ù„
    amount_irr = amount * currencies[from_currency]
    
    # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø§Ø±Ø² Ù…Ù‚ØµØ¯
    result = amount_irr / currencies[to_currency]
    
    # Ú©Ø§Ø±Ù…Ø²Ø¯ 0.1%
    fee = result * 0.001
    final = result - fee
    
    return {
        "success": True,
        "from": {
            "currency": from_currency,
            "amount": amount
        },
        "to": {
            "currency": to_currency,
            "amount": round(final, 8),
            "amount_before_fee": round(result, 8)
        },
        "fee": round(fee, 8),
        "fee_percent": "0.1%",
        "rate": round(currencies[to_currency] / currencies[from_currency], 8),
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/demo/wallet")
async def demo_wallet():
    """Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù†Ù…ÙˆÙ†Ù‡"""
    return {
        "user": "Ú©Ø§Ø±Ø¨Ø± Ù†Ù…ÙˆÙ†Ù‡",
        "user_id": "demo_123",
        "wallets": [
            {
                "currency": "IRR",
                "name": "Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†",
                "balance": 50000000,
                "balance_formatted": "50,000,000 ØªÙˆÙ…Ø§Ù†",
                "icon": "ğŸ’µ"
            },
            {
                "currency": "USDT",
                "name": "ØªØªØ±",
                "balance": 1000,
                "balance_irr": 1000 * PRICES["USDT"],
                "icon": "ğŸ’°"
            },
            {
                "currency": "BTC",
                "name": "Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†",
                "balance": 0.002,
                "balance_irr": 0.002 * PRICES["BTC"],
                "icon": "â‚¿"
            },
            {
                "currency": "Ã†THER",
                "name": "ØªÙˆÚ©Ù† Ø§ØªØ±ÛŒÙˆÙ†",
                "balance": 1000,
                "balance_irr": 1000 * PRICES["Ã†THER"],
                "icon": "âš¡"
            }
        ],
        "total_irr": 50000000 + (1000 * PRICES["USDT"]) + (0.002 * PRICES["BTC"]) + (1000 * PRICES["Ã†THER"])
    }

@app.get("/api/info")
async def system_info():
    """Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…"""
    return {
        "app": "Ã†THERION",
        "app_fa": "Ø§ØªØ±ÛŒÙˆÙ†",
        "version": "1.0.0",
        "description": "Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛŒÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ",
        "developer": "QalamHipHop",
        "repository": "https://github.com/QalamHipHop/-THERION",
        "features": {
            "wallet": "Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú†Ù†Ø¯Ø§Ø±Ø²ÛŒ",
            "exchange": "ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø²",
            "ai": "Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù…Ø§Ù„ÛŒ",
            "payment": "Ø¯Ø±Ú¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ÛŒØ±Ø§Ù†ÛŒ"
        },
        "supported_currencies": list(PRICES.keys()),
        "status": "operational",
        "timestamp": datetime.now().isoformat()
    }

# ==================== Ø§Ø¬Ø±Ø§ ====================
if __name__ == "__main__":
    print("=" * 50)
    print("ğŸŒŸ Ã†THERION - Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛŒÙ†")
    print("=" * 50)
    print("ğŸš€ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...")
    print()
    
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        log_level="info"
    )                                                                                                                                                                                                                                                                                                                                                                                                                            return response

                                                                                                                                                                                                                                                                                                                                                                                                                            # ================== Request Logging Middleware ==================
                                                                                                                                                                                                                                                                                                                                                                                                                            @app.middleware("http")
                                                                                                                                                                                                                                                                                                                                                                                                                            async def log_requests(request: Request, call_next):
                                                                                                                                                                                                                                                                                                                                                                                                                                start_time = datetime.now()
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                        # Log request
                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"ğŸ“¥ {request.method} {request.url.path}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Process request
                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = await call_next(request)
                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Log response
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    process_time = (datetime.now() - start_time).total_seconds()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"ğŸ“¤ {request.method} {request.url.path} - {response.status_code} ({process_time:.3f}s)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return response

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ================== Root Endpoints ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                @app.get("/", tags=["Root"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                async def root():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ API"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "app": settings.APP_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "version": settings.APP_VERSION,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "status": "running",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "message": "ğŸŒŸ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ã†THERION - Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú©Ø¯Ø§Ø±ÛŒ Ù†ÙˆÛŒÙ† Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "message_en": "Welcome to Ã†THERION - Advanced AI-Powered Banking System",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "docs": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "swagger": "/docs",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "redoc": "/redoc"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "endpoints": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "health": "/health",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "info": "/info"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "developer": "QalamHipHop",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "repository": "https://github.com/QalamHipHop/-THERION"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.get("/health", tags=["Health"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def health_check():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            health_status = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "status": "healthy",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "timestamp": datetime.now().isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "services": {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Ø¨Ø±Ø±Ø³ÛŒ Database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if 'check_database_health' in globals():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db_healthy = await check_database_health()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    health_status["services"]["database"] = "healthy" if db_healthy else "unhealthy"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        health_status["services"]["database"] = "not_configured"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    health_status["services"]["database"] = f"error: {str(e)}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Ø¨Ø±Ø±Ø³ÛŒ Redis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'redis_client' in globals():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    redis_healthy = await redis_client.redis.ping() if redis_client.redis else False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                health_status["services"]["redis"] = "healthy" if redis_healthy else "unhealthy"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    health_status["services"]["redis"] = "not_configured"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                health_status["services"]["redis"] = f"error: {str(e)}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return health_status

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.get("/info", tags=["Info"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def system_info():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "app_name": settings.APP_NAME,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "version": settings.APP_VERSION,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "environment": getattr(settings, 'ENVIRONMENT', 'development'),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "debug_mode": settings.DEBUG,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "features": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "ai_insights": getattr(settings, 'FEATURE_AI_INSIGHTS', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "auto_invest": getattr(settings, 'FEATURE_AUTO_INVEST', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "p2p_transfer": getattr(settings, 'FEATURE_P2P_TRANSFER', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "staking": getattr(settings, 'FEATURE_STAKING', False),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "supported_currencies": getattr(settings, 'SUPPORTED_CURRENCIES', ["IRR", "USD", "USDT", "BTC"]),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "payment_gateways": ["ZarinPal", "IDPay", "NextPay", "PayPing", "Zibal"],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "documentation": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "swagger_ui": "/docs",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "redoc": "/redoc"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ================== Demo Endpoints ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @app.get("/api/demo/currencies", tags=["Demo"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async def get_currencies():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡ (Ø¯Ù…Ùˆ)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "fiat": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {"code": "IRR", "name": "Ø±ÛŒØ§Ù„ Ø§ÛŒØ±Ø§Ù†", "symbol": "ï·¼"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {"code": "USD", "name": "Ø¯Ù„Ø§Ø± Ø¢Ù…Ø±ÛŒÚ©Ø§", "symbol": "$"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {"code": "EUR", "name": "ÛŒÙˆØ±Ùˆ", "symbol": "â‚¬"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "crypto": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {"code": "BTC", "name": "Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†", "symbol": "â‚¿"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {"code": "ETH", "name": "Ø§ØªØ±ÛŒÙˆÙ…", "symbol": "Î"},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {"code": "USDT", "name": "ØªØªØ±", "symbol": "â‚®"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "native": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "code": "Ã†THER",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "name": "ØªÙˆÚ©Ù† Ø§ØªØ±ÛŒÙˆÙ†",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "symbol": "âš¡"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.get("/api/demo/rates", tags=["Demo"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def get_exchange_rates():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Ù†Ø±Ø® Ø§Ø±Ø²Ù‡Ø§ (Ø¯Ù…Ùˆ - Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ ÙØ±Ø¶ÛŒ)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "timestamp": datetime.now().isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "base": "IRR",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "rates": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "USD": 0.000020,  # 1 Ø¯Ù„Ø§Ø± = 50,000 ØªÙˆÙ…Ø§Ù†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "EUR": 0.000018,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "BTC": 0.00000000004,  # 1 BTC = 2.5 Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ ØªÙˆÙ…Ø§Ù†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "ETH": 0.0000000067,   # 1 ETH = 150 Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "USDT": 0.000018,      # 1 USDT = 55,000 ØªÙˆÙ…Ø§Ù†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Ã†THER": 0.001         # 1 Ã†THER = 1,000 ØªÙˆÙ…Ø§Ù†
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "note": "Ø§ÛŒÙ† Ù†Ø±Ø®â€ŒÙ‡Ø§ ÙØ±Ø¶ÛŒ Ù‡Ø³ØªÙ†Ø¯. Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² API Ù‡Ø§ÛŒ Ù‚ÛŒÙ…Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                @app.post("/api/demo/calculate", tags=["Demo"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                async def calculate_exchange(from_currency: str, to_currency: str, amount: float):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø² (Ø¯Ù…Ùˆ)"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Ù†Ø±Ø®â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¶ÛŒ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            rates = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "IRR": 1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "USD": 50000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "EUR": 55000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "BTC": 2500000000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "ETH": 150000000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "USDT": 55000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "Ã†THER": 1000
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if from_currency not in rates or to_currency not in rates:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return JSONResponse(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status_code=400,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                content={"error": "Ø§Ø±Ø² Ù†Ø§Ù…Ø¹ØªØ¨Ø±"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Ù…Ø­Ø§Ø³Ø¨Ù‡
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    from_to_irr = amount * rates[from_currency]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        result = from_to_irr / rates[to_currency]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fee = result * 0.001  # Ú©Ø§Ø±Ù…Ø²Ø¯ 0.1Ùª
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                final = result - fee
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "from": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "currency": from_currency,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "amount": amount
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "to": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "currency": to_currency,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "amount": round(final, 8)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "rate": round(rates[to_currency] / rates[from_currency], 8),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "fee": round(fee, 8),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "timestamp": datetime.now().isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ================== Error Handlers ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.exception_handler(404)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def not_found_handler(request: Request, exc):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return JSONResponse(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status_code=404,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        content={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "error": "ÛŒØ§ÙØª Ù†Ø´Ø¯",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "message": f"Ù…Ø³ÛŒØ± {request.url.path} ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "suggestion": "Ø¨Ù‡ /docs Ø¨Ø±ÙˆÛŒØ¯ ØªØ§ Ù„ÛŒØ³Øª APIÙ‡Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.exception_handler(500)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def internal_error_handler(request: Request, exc):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.error(f"Internal error: {exc}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return JSONResponse(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_code=500,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                content={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "error": "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "message": "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø³Ø±ÙˆØ± Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ================== Run Server ==================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import uvicorn
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uvicorn.run(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "app.main:app",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            host="0.0.0.0",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    port=8000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            reload=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    log_level="info"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
